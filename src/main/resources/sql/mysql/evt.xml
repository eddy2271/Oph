<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="evt">
   <!-- 파트너/클라이언트 리스트 가져오기 -->
   <select id="getAthList" resultType="map" parameterType="hashMap">
      SELECT CODE.CODE_VAL, CODE.CODE_VAL_DESC
        FROM tmb_user USER
        LEFT OUTER JOIN tmb_code CODE
          ON USER.USER_CODE_VAL = CODE.CODE_VAL
       WHERE USER.USER_CODE_VAL != 'ATH999'
         AND USER.USER_DIV = #{userDiv}
      <if test='userId != null and userId != ""'>
         AND USER.USER_ID = #{userId}
      </if>
       GROUP BY CODE.CODE_VAL, CODE.CODE_VAL_DESC
       ORDER BY CODE.CODE_VAL_DESC
   </select>
   
   <!-- 연관된 클라이언트 리스트 가져오기 -->
   <select id="getClientList" resultType="map" parameterType="hashMap">
       SELECT CODE.CODE_VAL, CODE.CODE_VAL_DESC
         FROM tmb_event EVT
         LEFT OUTER JOIN tmb_code CODE
           ON EVT.EVT_CLNT_CODE = CODE.CODE_VAL
        WHERE EVT.EVT_PARTNER_CODE = #{userCodeVal}
        GROUP BY EVT.EVT_CLNT_CODE, CODE.CODE_VAL_DESC
        ORDER BY CODE.CODE_VAL
   </select>
   
   <!-- 예약현황 리스트 가져오기 -->
   <select id="getRevList" resultType="map">
      SELECT CODE_VAL, CODE_VAL_DESC
        FROM tmb_code
       WHERE CODE_DIV = 'REV'
       ORDER BY CODE_VAL
   </select>
   
   <!-- 이벤트 리스트 가져오기 -->
   <select id="getEvtList" resultType="map" parameterType="hashMap">
      SELECT ROW_NUMBER() OVER(ORDER BY EVT_SEQ ASC) NUM, EVT_SEQ, EVT_CLNT_CODE, EVT_USER_NM, EVT_USER_AGE, EVT_USER_PH_NUM, EVT_AR_NM, EVT_STS_CD, EVT_PARTNER_CODE
          , (SELECT CODE_VAL_DESC FROM tmb_code WHERE CODE_VAL = EVT_CLNT_CODE) EVT_CLNT_NM
          , (SELECT CODE_VAL_DESC FROM tmb_code WHERE CODE_VAL = EVT_PARTNER_CODE) EVT_PARTNER_NM
          , (SELECT CODE_VAL_DESC FROM tmb_code WHERE CODE_VAL = EVT_STS_CD) EVT_STS_NM
           , EVT_SURVEY1, EVT_SURVEY2, EVT_SURVEY3, EVT_SURVEY4, EVT_SURVEY5, EVT_SURVEY6, EVT_DESC, EVT_IP
           , DATE_FORMAT(REG_DT, '%Y년 %m월 %d일') REG_DT
           , DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i') REG_DT_EXCEL
           , CASE WHEN EVT_SURVEY2 = '' THEN '1'
                    WHEN EVT_SURVEY3 = '' THEN '2'
                    WHEN EVT_SURVEY4 = '' THEN '3'
                    WHEN EVT_SURVEY5 = '' THEN '4'
                    WHEN EVT_SURVEY6 = '' THEN '5'
              ELSE '6' END SURVEY_CNT
        FROM tmb_event
       WHERE 1=1
      <if test='client != null and client != ""'>
         AND EVT_CLNT_CODE = #{client}
      </if>
      <if test='partner != null and partner != ""'>
         AND EVT_PARTNER_CODE = #{partner}
      </if>
      <if test='rev != null and rev != ""'>
         AND EVT_STS_CD = #{rev}
      </if>
      <if test='searchKey != null and searchKey != ""'>
         <choose>
            <when test='searchKey == "name"'>
               AND EVT_USER_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
            <when test='searchKey == "ph"'>
               AND EVT_USER_PH_NUM = #{searchText}
            </when>
            <when test='searchKey == "arNm"'>
               AND EVT_AR_NM LIKE CONCAT('%', #{searchText}, '%')
            </when>
         </choose>
      </if>
      <if test='startDate != null and startDate != "" and endDate != null and endDate != ""'>
         AND DATE_FORMAT(REG_DT, '%Y-%m-%d') BETWEEN #{startDate} AND #{endDate}
      </if>
   </select>
   
   <!-- 데이터 저장하기 -->
   <insert id="saveEvt" parameterType="hashMap">
      INSERT INTO tmb_event (
         EVT_CLNT_CODE,
         EVT_PARTNER_CODE,
         EVT_USER_NM,
         EVT_USER_AGE,
         EVT_USER_PH_NUM,
         EVT_AR_NM,
         EVT_STS_CD,
         EVT_SURVEY1,
         EVT_SURVEY2,
         EVT_SURVEY3,
         EVT_SURVEY4,
         EVT_SURVEY5,
         EVT_SURVEY6,
         EVT_DESC,
         EVT_IP,
         REG_DT )
      VALUES (
         #{clientModal},
         #{partnerModal},
         #{evtUserNm},
         #{evtUserAge},
         #{evtUserPhNum},
         #{evtArNm},
         #{revModal},
         #{evtSurvey1},
         #{evtSurvey2},
         #{evtSurvey3},
         #{evtSurvey4},
         #{evtSurvey5},
         #{evtSurvey6},
         #{evtDesc},
         #{evtIp},
         NOW() )
   </insert>
   
   <!-- 데이터 수정하기 -->
   <update id="updateEvt" parameterType="hashMap">
      UPDATE tmb_event
         SET EVT_CLNT_CODE = #{clientModal}
           , EVT_PARTNER_CODE = #{partnerModal}
           , EVT_USER_NM = #{evtUserNm}
           , EVT_USER_AGE = #{evtUserAge}
           , EVT_USER_PH_NUM = #{evtUserPhNum}
           , EVT_AR_NM = #{evtArNm}
           , EVT_STS_CD = #{revModal}
           , EVT_SURVEY1 = #{evtSurvey1}
           , EVT_SURVEY2 = #{evtSurvey2}
           , EVT_SURVEY3 = #{evtSurvey3}
           , EVT_SURVEY4 = #{evtSurvey4}
           , EVT_SURVEY5 = #{evtSurvey5}
           , EVT_SURVEY6 = #{evtSurvey6}
           , EVT_DESC = #{evtDesc}
           , EVT_IP = #{evtIp}
           , REG_DT = NOW()
       WHERE EVT_SEQ = #{evtSeq}
   </update>
   
   <!-- 데이터 삭제하기 -->
   <delete id="removeEvt">
      DELETE FROM tmb_event
       WHERE EVT_SEQ IN
      <foreach item="item" collection="delList" open="(" separator="," close=")">
          #{item}
       </foreach>
   </delete>
</mapper>